<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI教学范式 - 交互式终端演示 (v9.0 最终完整版)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-main: #f4f7f9; --bg-terminal: #ffffff; --bg-input-area: #f8fafc;
            --text-color: #334155; --prompt-color: #007bff; --output-color: #6f42c1;
            --title-color: #d9480f; --border-color: #e2e8f0; --shadow-color: rgba(100, 116, 139, 0.12);
            --font-main: 'Poppins', 'Helvetica Neue', sans-serif; --font-mono: 'Fira Code', 'Menlo', 'Consolas', monospace;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; }
        body {
            font-family: var(--font-main); background-color: var(--bg-main); color: var(--text-color);
            display: flex; justify-content: center; align-items: center; padding: 20px;
        }
        。terminal-container {
            width: 100%; height: 100%; max-width: 900px; max-height: 90vh;
            display: flex; flex-direction: column; background-color: var(--bg-terminal);
            border-radius: 12px; border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color);
            overflow: hidden;
        }
        。terminal { flex-grow: 1; padding: 25px; overflow-y: auto; font-size: 14px; }
        。terminal::-webkit-scrollbar { width: 8px; }
        。terminal::-webkit-scrollbar-track { background: var(--bg-input-area); }
        。terminal::-webkit-scrollbar-thumb { background-color: #cbd5e0; border-radius: 4px; }
        。terminal::-webkit-scrollbar-thumb:hover { background-color: #a0aec0; }
        .line { margin-bottom: 12px; white-space: pre-wrap; line-height: 1.7; opacity: 0; animation: slideIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .line.user-input { color: var(--prompt-color); font-weight: 500; }
        .line.user-input::before { content: '» '; }
        .line.system-output.title { color: var(--title-color); font-weight: 700; font-size: 1.3em; }
        .line.system-output.help { color: var(--prompt-color); opacity: 0.8; }
        .line .highlight, .line .help a { color: var(--output-color); font-weight: 500; text-decoration: none; transition: all 0.2s ease; }
        .line .help a:hover { color: #fff; background-color: var(--output-color); padding: 2px 6px; border-radius: 4px; }
        .line.system-output.error { color: #dc2626; font-weight: 500; }
        .input-area { display: flex; align-items: center; padding: 15px 25px; background-color: var(--bg-input-area); border-top: 1px solid var(--border-color); }
        .input-area-prompt { color: var(--prompt-color); font-size: 1.2em; margin-right: 10px; font-family: var(--font-mono); }
        .input-wrapper { flex-grow: 1; display: flex; align-items: center; position: relative; }
        #commandInput { width: 100%; background: none; border: none; color: var(--text-color); font-family: var(--font-mono); font-size: 1.1em; padding-right: 15px; }
        #commandInput:focus { outline: none; }
        #commandInput:focus + .blinking-caret { display: inline-block; width: 8px; height: 1.2em; background: var(--prompt-color); animation: blink 1s infinite; position: absolute; left: 0; }
        .blinking-caret { display: none; }
        @keyframes blink { 50% { opacity: 0; } }
        #executeBtn { background-color: var(--prompt-color); color: #ffffff; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-left: 10px; font-family: var(--font-main); font-weight: 500; transition: all 0.2s ease; }
        #executeBtn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); }
        pre { font-family: var(--font-mono); background-color: #f8fafc; padding: 15px; border-radius: 5px; border: 1px solid var(--border-color); white-space: pre-wrap; word-wrap: break-word; font-size: 0.95em; color: #52525b; position: relative; }
        .copy-code-btn { position: absolute; top: 8px; right: 8px; background-color: #e2e8f0; color: #64748b; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: all 0.2s ease; opacity: 0; }
        pre:hover .copy-code-btn { opacity: 1; }
        .copy-code-btn:hover { background-color: #cbd5e1; }
        .copy-code-btn.copied { background-color: #4ade80; color: #fff; }
        .thinking-indicator { display: flex; align-items: center; color: #94a3b8; }
        .thinking-indicator .spinner { width: 14px; height: 14px; border: 2px solid var(--prompt-color); border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: all 0.4s ease; background-color: rgba(248, 250, 252, 0.5); backdrop-filter: blur(8px); }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { position: relative; background-color: rgba(255, 255, 255, 0.8); padding: 20px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.9); max-width: 90%; max-height: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .modal-content img, .modal-content video, .modal-content iframe { max-width: 100%; max-height: 80vh; display: none; border-radius: 4px; }
        .modal-close-btn { position: absolute; top: -15px; right: -15px; width: 35px; height: 35px; background-color: var(--text-color); color: #ffffff; border-radius: 50%; border: 2px solid #fff; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; line-height: 1; transition: transform 0.2s ease; }
        .modal-close-btn:hover { transform: scale(1.1) rotate(90deg); }
    </style>
</head>
<body>
    <div class="terminal-container">
        <div class="terminal" id="terminalOutput"></div>
        <div class="input-area">
            <span class="input-area-prompt">></span>
            <div class="input-wrapper">
                <input type="text" id="commandInput" placeholder="输入指令..." autofocus>
                <span class="blinking-caret"></span>
            </div>
            <button id="executeBtn">执行</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="mediaModal">
        <div class="modal-content">
            <button class="modal-close-btn" id="modalCloseBtn">×</button>
            <img id="modalImage" src="" alt="示意图">
            <video id="modalVideo" src="" controls></video>
            <iframe id="modalIframe" src="" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="display: none; width: 80vw; height: 45vw; max-width: 1280px; max-height: 720px;"></iframe>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM元素获取 ---
            const terminalOutput = document.getElementById('terminalOutput');
            const commandInput = document.getElementById('commandInput');
            const executeBtn = document.getElementById('executeBtn');
            const mediaModal = document.getElementById('mediaModal');
            const modalImage = document.getElementById('modalImage');
            const modalVideo = document.getElementById('modalVideo');
            const modalIframe = document.getElementById('modalIframe');
            const modalCloseBtn = document.getElementById('modalCloseBtn');
            const caret = document.querySelector('.blinking-caret');
            
            // --- 资源与状态变量 ---
            const dsImageUrl = './images/ds-diagram.jpg'; // <-- 修改这里
            const dsVideoUrl = '//player.bilibili.com/player.html?bvid=BV1F44y1G7vm&page=1&high_quality=1&as_wide=1';
            const chLitImageUrl = 'https://img.allhistory.com/5f571c76851391000187ea30.png?imageView2/2/w/750/h/500/|imageMogr2/strip/interlace/1/quality/75/format/jpg';

            let commandHistory = [];
            let historyIndex = -1;
            
            let inDsDemoMode = false;
            let dsQuicksortActive = false;
            let inChLitDemoMode = false;
            let chLitChibiFuActive = false;

            // --- 响应数据库 (完整版) ---
            const responses = {
                '1': [
                    { type: 'title', text: '加载中: (一) 多模态学科知识图谱框架' }, 
                    { type: 'normal', text: '核心思想：为特定学科（如数据结构）构建一个统一的、多模态的知识框架。'},
                    { type: 'normal', text: `### 1. 构建基础框架\n- <span class="highlight">学科知识本体设计：</span>针对《数据结构》，设计包含“树”、“图”等核心概念的层次结构。\n- <span class="highlight">知识抽取：</span>利用大语言模型从教材中自动抽取实体关系，如“快速排序的时间复杂度是O(n log n)”。\n\n### 2. 多模态知识融合\n- <span class="highlight">知识表示：</span>研究将教材文本、实验图表、教学视频映射到统一向量空间。\n- <span class="highlight">实体对齐：</span>利用图神经网络，将视频中的动画片段与代码指令进行对齐。`}
                ],
                '2': [
                    { type: 'title', text: '加载中: (二) 检索增强的大语言模型生成范式' }, 
                    { type: 'normal', text: '核心思想：利用构建好的知识图谱，克服大语言模型的“幻觉”，提高生成内容的专业性和准确性。'},
                    { type: 'normal', text: `### 1. 图检索增强生成 (GraphRAG)\n- <span class="highlight">图基索引与检索：</span>当用户提问时，能从图谱中检索到全面的知识上下文。\n- <span class="highlight">上下文感知生成：</span>将检索到的知识注入大语言模型，确保生成答案的准确性。\n\n### 2. 知识嵌入机制\n- <span class="highlight">引导与推理：</span>设计思维链提示，引导大模型进行步骤化推理。\n- <span class="highlight">动态演化：</span>构建增量学习框架，动态更新知识图谱，解决知识过时问题。`}
                ],
                '3': [{ type: 'title', text: '加载中: (三) “数据结构”教学案例演示' }, { type: 'normal', text: '这是一个模拟场景，展示当学生向AI助教提问时，系统如何工作。' }, { type: 'help', text: '现在，请输入指令 <a>quicksort</a> 来模拟学生的提问。' }],
                'quicksort': [
                    { type: 'normal', text: '接收到用户提问: "请用一个初学者能听懂的例子，解释一下什么是快速排序..."' }, 
                    { type: 'normal', text: '<span class="highlight">GraphRAG 系统启动...</span>'}, 
                    { type: 'normal', text: '1. <span class="highlight">[图检索]</span> 成功! 在“数据结构”知识图谱中检索到相关节点。'}, 
                    { type: 'normal', text: '2. <span class="highlight">[知识整合]</span> 成功! 已获取多模态知识片段。'}, 
                    { type: 'normal', text: '3. <span class="highlight">[增强生成]</span> 成功! 将上下文注入大语言模型，开始生成回答...'}, 
                    { type: 'title', text: '--- AI助教生成结果 ---' }, 
                    { 
                        type: 'normal', 
                        effect: 'typing', 
                        text: `当然！我们可以把<strong>快速排序</strong>想象成在一个班级里按身高排队。\n\n<strong>第一步：选个“基准” (Pivot)</strong>\n我们随便从队伍里拉一个同学出来，比如小明（身高175cm），让他当“基准”。\n\n<strong>第二步：分区 (Partition)</strong>\n比小明矮的站左边，比他高的站右边。操作结束后，小明的位置就固定了。\n\n<strong>第三步：递归 (Recursion)</strong>\n对左右两边的“小队伍”重复以上步骤，直到所有人都排好。\n\n<pre><code>def quick_sort(arr):\n    if len(arr) <= 1:\n        return arr\n    pivot = arr[len(arr) // 2]\n    left = [x for x in arr if x < pivot]\n    middle = [x for x in arr if x == pivot]\n    right = [x for x in arr if x > pivot]\n    return quick_sort(left) + middle + quick_sort(right)\n\nprint(quick_sort([3, 6, 8, 10, 1, 2, 1]))\n# 输出: [1, 1, 2, 3, 6, 8, 10]</code></pre>`
                    },
                    { type: 'help', text: '<span class="highlight">-> 请输入 <a>show image</a> 查看分区过程示意图。</span>'},
                    { type: 'help', text: '<span class="highlight">-> 请输入 <a>show video</a> 查看递归动画演示。</span>'},
                    { type: 'help', text: '<span class="highlight">-> 思考题：如果数组已经有序，快排效率如何？输入 <a>compare complexity</a> 深入了解。</span>'}
                ],
                'compare complexity': [
                    { type: 'title', text: '知识深化：快速排序的复杂度' }, 
                    { type: 'normal', text: '这是一个非常好的问题，触及了快速排序的关键弱点！' },
                    { type: 'normal', text: `如果对一个<span class="highlight">已经有序</span>（或接近有序）的数组使用基础的快速排序（比如总是选第一个或最后一个元素作基准），会发生<span class="highlight">最坏情况</span>。\n\n每次分区，都会导致一个子数组为空，另一个子数组只比原来少一个元素。这使得递归树变成一条长链，深度为n，失去了分治的优势。\n\n因此，最坏情况下的时间复杂度会退化到 **O(n²)**，和冒泡排序一样慢。\n\n为了解决这个问题，实际应用中的快速排序会采用“三数取中”或“随机选取基准”等策略来避免最坏情况的发生。`}
                ],
                'show image': [{ type: 'normal', text: '正在打开示意图...' }],
                'show video': [{ type: 'normal', text: '正在加载演示视频...' }],
                '4': [{ type: 'title', text: '加载中: (四) “大学语文”教学案例演示' }, { type: 'normal', text: '此场景将演示AI助教如何分析古典文学中的哲学思想。' }, { type: 'help', text: '现在，请输入指令 <a>chibifu</a> 来提问关于《前赤壁赋》的核心思想。' }],
                'chibifu': [
                    { type: 'normal', text: '接收到用户提问: "请分析苏轼《前赤壁赋》中\'变\'与\'不变\'的哲学思想..."' },
                    { type: 'normal', text: '<span class="highlight">GraphRAG 系统启动...</span>'},
                    { type: 'normal', text: '1. <span class="highlight">[图检索]</span> 成功! 在“中国古典文学”知识图谱中检索到“苏轼”、“赤壁赋”、“道家思想”等相关节点。'},
                    { type: 'normal', text: '2. <span class="highlight">[知识整合]</span> 成功! 已获取文本核心引文、作者生平背景、相关画作及音乐等6个多模态知识片段。'},
                    { type: 'normal', text: '3. <span class="highlight">[增强生成]</span> 成功! 将上下文注入大语言模型，开始生成回答...'},
                    { type: 'title', text: '--- AI助教生成结果 ---' },
                    { type: 'normal', effect: 'typing', text: `您好！苏轼在《前赤壁赋》中探讨的“变”与“不变”是其旷达人生观的核心体现，深受道家思想影响。\n\n<strong>“变”</strong>：从事物表象来看，一切都在变化。如江水东流，人事代谢，生命短暂，这是苏轼与客人都感受到的，因而引发了“哀吾生之须臾”的感慨。\n\n<strong>“不变”</strong>：但从本质和宇宙的宏观视角看，万物又是永恒的。苏轼提出“自其不变者而观之，则物与我皆无尽也”。江水虽流逝，但江水本身未曾消失；明月虽有盈亏，但月亮本体亘古长存。他借此超越了个人的渺小和生命的短暂，与自然万物融为一体。\n\n这种从“变”中看到“不变”的思辨，帮助苏轼在被贬的逆境中找到了精神慰藉，实现了自我超越。`},
                    { type: 'help', text: '<span class="highlight">-> 请输入 <a>show text</a> 查看核心原文。</span>' },
                    { type: 'help', text: '<span class="highlight">-> 请输入 <a>show painting</a> 欣赏《赤壁赋》图。</span>' },
                    { type: 'help', text: '<span class="highlight">-> 请输入 <a>play music</a> 聆听主题古琴曲。</span>' },
                    { type: 'help', text: '<span class="highlight">-> 思考题：结合苏轼生平，这种人生观对他有何影响？输入 <a>discuss impact</a> 查看分析。</span>' }
                ],
                'show text': [ { type: 'title', text: '《前赤壁赋》核心原文' }, { type: 'normal', text: `<pre><code>客亦知夫水与月乎？\n逝者如斯，而未尝往也；\n盈虚者如彼，而卒莫消长也。\n盖将自其变者而观之，则天地曾不能以一瞬；\n自其不变者而观之，则物与我皆无尽也。</code></pre>` } ],
                'show painting': [{ type: 'normal', text: '正在打开《赤壁赋》相关画作...' }],
                'play music': [{ type: 'normal', text: '模拟播放古琴曲《秋江夜泊》，营造《赤壁赋》的宁静与旷远意境...' }],
                'discuss impact': [ 
                    { type: 'title', text: '知识深化：人生观对苏轼的影响' }, 
                    { type: 'normal', text: '这个问题非常关键！这种“变与不变”的旷达人生观，是苏轼屡遭贬谪而依然能创作出大量优秀作品的<span class="highlight">精神支柱</span>。\n\n它让苏轼能够：\n1.  <strong>超越个人得失</strong>：将个人的不幸置于广阔的宇宙时空中，从而获得释然。\n2.  <strong>随缘自适</strong>：无论身处何地，都能发现生活中的美好与乐趣，即“随所遇而安”。\n3.  <strong>保持积极乐观</strong>：即使在政治上屡受打击，依然能保持豪放豁达的胸襟和对生活的热爱。' 
                } ],
                'help': [ 
                    { type: 'help', text: '通用指令:' }, 
                    { type: 'help', text: '- <a>1</a> / <a>2</a> : 查看核心研究方向'}, 
                    { type: 'help', text: '- <a>3</a> : 进入“数据结构”案例'}, 
                    { type: 'help', text: '- <a>4</a> : 进入“大学语文”案例'}, 
                    { type: 'help', text: '- <a>clear</a> / <a>help</a> : 清屏 / 显示帮助'} 
                ]
            };

            const addCopyButton = (codeBlock) => {
                const copyBtn = document.createElement('button');
                copyBtn.innerText = '复制';
                copyBtn.className = 'copy-code-btn';
                copyBtn.addEventListener('click', () => {
                    const codeToCopy = codeBlock.querySelector('code').innerText;
                    navigator.clipboard.writeText(codeToCopy).then(() => {
                        copyBtn.innerText = '已复制!';
                        copyBtn.classList.add('copied');
                        setTimeout(() => { copyBtn.innerText = '复制'; copyBtn.classList.remove('copied'); }, 2000);
                    });
                });
                codeBlock.appendChild(copyBtn);
            };
            
            const typeEffect = (element, html, onComplete) => {
                let i = 0; const speed = 20;
                const tempDiv = document.createElement('div'); tempDiv.innerHTML = html;
                const text = tempDiv.textContent || tempDiv.innerText || "";
                element.innerHTML = "";
                function typing() {
                    if (i < text.length) {
                        element.innerHTML += text.charAt(i); i++;
                        terminalOutput.scrollTop = terminalOutput.scrollHeight;
                        setTimeout(typing, speed);
                    } else {
                        element.innerHTML = html;
                        const codeBlock = element.querySelector('pre');
                        if (codeBlock) addCopyButton(codeBlock);
                        if (onComplete) onComplete();
                    }
                }
                typing();
            };

            const printLine = (lineInfo) => {
                return new Promise(resolve => {
                    const { text, type = 'normal', effect } = lineInfo;
                    const line = document.createElement('div');
                    line.classList.add('line', 'system-output', type);
                    const html = text.replace(/<a>(.*?)<\/a>/g, '<a href="#" class="cmd-link">$1</a>').replace(/### (.*$)/gim, '<h3>$1</h3>').replace(/## (.*$)/gim, '<h2>$1</h2>').replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>').replace(/^\s*[-*] (.*$)/gim, '<li>$1</li>');
                    if (effect === 'typing') {
                        terminalOutput.appendChild(line);
                        typeEffect(line, html, resolve);
                    } else {
                        line.innerHTML = html;
                        const codeBlock = line.querySelector('pre');
                        if (codeBlock) addCopyButton(codeBlock);
                        terminalOutput.appendChild(line);
                        terminalOutput.scrollTop = terminalOutput.scrollHeight;
                        resolve();
                    }
                });
            };

            async function executeCommand(command) {
                if (!command) return;
                const userInputLine = document.createElement('div');
                userInputLine.classList.add('line', 'user-input');
                userInputLine.textContent = command;
                terminalOutput.appendChild(userInputLine);
                if (command !== (commandHistory[commandHistory.length - 1] || '')) {
                    commandHistory.push(command);
                }
                historyIndex = commandHistory.length;
                const cmd = command.toLowerCase().trim();
                if (cmd === 'quicksort' && !inDsDemoMode) {
                    await printLine({ text: '请先输入指令 <a>3</a> 进入“数据结构”案例。', type: 'error' });
                    commandInput.value = ''; return;
                }
                if (['show image', 'show video', 'compare complexity'].includes(cmd) && !dsQuicksortActive) {
                    await printLine({ text: '请先在“数据结构”案例中运行 <a>quicksort</a>。', type: 'error' });
                    commandInput.value = ''; return;
                }
                if (cmd === 'chibifu' && !inChLitDemoMode) {
                    await printLine({ text: '请先输入指令 <a>4</a> 进入“大学语文”案例。', type: 'error' });
                    commandInput.value = ''; return;
                }
                if (['show text', 'show painting', 'play music', 'discuss impact'].includes(cmd) && !chLitChibiFuActive) {
                    await printLine({ text: '请先在“大学语文”案例中运行 <a>chibifu</a>。', type: 'error' });
                    commandInput.value = ''; return;
                }
                const contextResettingCommands = ['1', '2', '3', '4', 'help', 'clear'];
                if (contextResettingCommands.includes(cmd)) {
                    inDsDemoMode = false; dsQuicksortActive = false;
                    inChLitDemoMode = false; chLitChibiFuActive = false;
                }
                commandInput.value = '';
                commandInput.disabled = true;
                const thinkingIndicator = document.createElement('div');
                thinkingIndicator.className = 'line thinking-indicator';
                thinkingIndicator.innerHTML = '<div class="spinner"></div>正在思考...';
                terminalOutput.appendChild(thinkingIndicator);
                await new Promise(res => setTimeout(res, 300 + Math.random() * 300));
                thinkingIndicator.remove();
                const responseLines = responses[cmd];
                if (cmd === 'clear') {
                    terminalOutput.innerHTML = '';
                } else if (responseLines) {
                    for (const lineInfo of responseLines) {
                        await printLine(lineInfo);
                    }
                    if (cmd === 'show image') showModal('image', dsImageUrl);
                    if (cmd === 'show video') showModal('iframe', dsVideoUrl);
                    if (cmd === 'show painting') showModal('image', chLitImageUrl);
                    if (cmd === '3') inDsDemoMode = true;
                    if (cmd === 'quicksort') dsQuicksortActive = true;
                    if (cmd === '4') inChLitDemoMode = true;
                    if (cmd === 'chibifu') chLitChibiFuActive = true;
                } else {
                    await printLine({ text: `指令 "${command}" 未找到。请输入 <a href="#" class="cmd-link">help</a> 查看可用指令。`, type: 'error' });
                }
                commandInput.disabled = false;
                commandInput.focus();
            }

            const showModal = (type, url) => {
                mediaModal.classList.add('visible');
                modalImage.style.display = 'none';
                modalVideo.style.display = 'none';
                modalIframe.style.display = 'none';

                if (type === 'image') {
                    modalImage.style.display = 'block';
                    modalImage.src = url;
                } else if (type === 'video') {
                    modalVideo.style.display = 'block';
                    modalVideo.src = url;
                    modalVideo.play();
                } else if (type === 'iframe') {
                    modalIframe.style.display = 'block';
                    modalIframe.src = url;
                }
            };
            const closeModal = () => {
                mediaModal.classList.remove('visible');
                modalVideo.pause();
                modalIframe.src = ''; 
            };
            
            const updateCaretPosition = () => {
                const tempSpan = document.createElement('span');
                tempSpan.style.font = window.getComputedStyle(commandInput).font;
                tempSpan.textContent = commandInput.value.substring(0, commandInput.selectionStart);
                document.body.appendChild(tempSpan);
                const textWidth = tempSpan.offsetWidth;
                document.body.removeChild(tempSpan);
                caret.style.transform = `translateX(${textWidth}px)`;
            };

            executeBtn.addEventListener('click', () => executeCommand(commandInput.value));
            commandInput.addEventListener('keydown', e => {
                if (e.key === 'Enter') {
                    executeCommand(commandInput.value);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (historyIndex > 0) {
                        historyIndex--;
                        commandInput.value = commandHistory[historyIndex];
                        commandInput.setSelectionRange(commandInput.value.length, commandInput.value.length);
                    }
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (historyIndex < commandHistory.length - 1) {
                        historyIndex++;
                        commandInput.value = commandHistory[historyIndex];
                        commandInput.setSelectionRange(commandInput.value.length, commandInput.value.length);
                    } else {
                        historyIndex = commandHistory.length;
                        commandInput.value = '';
                    }
                }
            });
            terminalOutput.addEventListener('click', e => {
                const targetLink = e.target.closest('.cmd-link');
                if (targetLink) {
                    e.preventDefault();
                    const cmdText = targetLink.textContent;
                    commandInput.value = cmdText;
                    executeCommand(cmdText);
                }
            });
            modalCloseBtn.addEventListener('click', closeModal);
            mediaModal.addEventListener('click', e => { if (e.target === mediaModal) closeModal(); });
            commandInput.addEventListener('input', () => { historyIndex = commandHistory.length; updateCaretPosition(); });
            commandInput.addEventListener('keyup', updateCaretPosition);
            commandInput.addEventListener('click', updateCaretPosition);

            async function init() {
                await printLine({ text: 'AI 教学系统终端 // 版本 v9.0 (完整版)', type: 'title'});
                await printLine({ text: '系统已稳定运行，所有功能和文本已完全恢复。', type: 'normal' });
                await printLine({ text: '请输入 <a>help</a> 查看所有可用指令。', type: 'help' });
                commandInput.focus();
            }
            
            init();
        });
    </script>
</body>
</html>
